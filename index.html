<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Reporte de Impresores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        /* --- Estilos generales --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eaeaea;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 40px;
        }
        .container {
            background: #fff;
            padding: 25px;
            margin: 15px;
            width: 100%;
            max-width: 420px;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        /* --- AJUSTES DE PORTADA WEB (NO PDF) --- */
        .logo {
            width: 200px; /* Puedes ajustar este valor a tu gusto */
            height: auto;
            display: block;
            margin: 0 auto 10px auto; 
            object-fit: contain; 
        }
        h1 {
            font-size: 1.6rem;
            margin-top: 0; 
            margin-bottom: 25px;
            color: #2c3e50;
        }
        /* --- FIN DE AJUSTES DE PORTADA WEB --- */

        /* Formulario portada */
        .form-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
            text-align: center;
        }
        input[type="text"] {
            padding: 12px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #007BFF;
            color: white;
            padding: 14px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }

        /* Botones secciones */
        #botonesSecciones {
            margin-top: 20px;
            text-align: center;
        }
        .seccion-btn {
            display: block;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            margin: 10px auto;
            width: 90%;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.1rem;
        }
        .seccion-btn:hover {
            background-color: #217dbb;
        }

        /* Contenido sección desplegable */
        .contenido-seccion {
            background: #f3f6fb;
            margin: 0 auto 25px auto;
            max-width: 90%;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            display: none;
            text-align: center;
        }
        .contenido-seccion h3 {
            margin-top: 0;
            color: #34495e;
        }

        /* Botones dentro de sección */
        .btn-foto {
            background-color: #2ecc71;
            border: none;
            color: white;
            padding: 10px 20px;
            margin: 8px 6px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-foto:hover {
            background-color: #27ae60;
        }

        /* Preview imágenes y botón de eliminar */
        .preview-images {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        .image-container {
            position: relative;
            display: inline-block;
        }
        .preview-images img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            object-fit: cover;
        }
        .delete-image-btn {
            position: absolute;
            top: -5px; 
            right: -5px; 
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            line-height: 1; 
            padding: 0;
            z-index: 10;
        }
        .delete-image-btn:hover {
            background-color: #c0392b;
        }

        /* Comentario */
        textarea {
            width: 100%;
            margin-top: 20px;
            min-height: 80px;
            padding: 10px;
            resize: vertical;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Botón "Nuevo Reporte" (antes "Volver a portada") */
        #btnNuevoReporte { /* Cambiado de #btnVolver */
            background-color: #e74c3c;
            margin-top: 20px; /* Ajuste para dar espacio si es necesario */
        }
        #btnNuevoReporte:hover { /* Cambiado de #btnVolver */
            background-color: #c0392b;
        }

        /* Indicador de carga */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 1.5rem;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 420px) {
            .seccion-btn, .btn-foto {
                width: 95%;
                font-size: 1rem;
            }
            .preview-images img {
                max-width: 70px;
                max-height: 70px;
            }
        }
    </style>
</head>
<body>

    <div class="container" id="portada">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSroamFoZxhxDK8iAOsHT5NB7nFY9rlpPEr6w&s" alt="Logo Freund" class="logo" />
        <h1>Reporte de Impresores</h1>
        <form id="inicioForm">
            <div class="form-group">
                <label for="tienda">Nombre de la tienda</label>
                <input type="text" id="tienda" name="tienda" required />
            </div>
            <div class="form-group">
                <label for="persona">Responsable</label>
                <input type="text" id="persona" name="persona" required />
            </div>
            <button type="submit">Comenzar</button>
        </form>
    </div>

    <div class="container" id="mainApp" style="display:none; text-align:center;">
        <div id="botonesSecciones"></div>

        <button id="generarPDF" style="margin-top:30px; background:#34495e;">Generar Reporte PDF</button>
        
        <button id="btnNuevoReporte" type="button">Nuevo Reporte</button> 
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p>Generando PDF...</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;

        const portada = document.getElementById("portada");
        const mainApp = document.getElementById("mainApp");
        const inicioForm = document.getElementById("inicioForm");
        const botonesSecciones = document.getElementById("botonesSecciones");
        const btnNuevoReporte = document.getElementById("btnNuevoReporte"); // Nuevo ID
        const generarPDFBtn = document.getElementById("generarPDF");
        const loadingOverlay = document.getElementById("loadingOverlay");

        const secciones = [
            "Recepción",
            "Sala de Recibo",
            "Eléctrico",
            "Herraje",
            "Pintura",
            "Fontanería"
        ];

        const LOGO_URL = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSroamFoZxhxDK8iAOsHT5NB7nFY9rlpPEr6w&s";
        let logoBase64 = null; 
        let logoOriginalWidth = 0; 
        let logoOriginalHeight = 0; 

        const loadLogoAsBase64 = () => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.onload = () => {
                    logoOriginalWidth = img.width;
                    logoOriginalHeight = img.height;

                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    logoBase64 = canvas.toDataURL("image/png"); 
                    console.log("Logo cargado y convertido a Base64 con éxito. Dimensiones originales:", logoOriginalWidth, "x", logoOriginalHeight);
                    resolve();
                };
                img.onerror = (error) => {
                    console.error("Error al cargar el logo para Base64. Esto puede ser un problema de CORS o la URL de la imagen no es accesible:", error);
                    logoBase64 = null;
                    logoOriginalWidth = 0; 
                    logoOriginalHeight = 0;
                    reject(error);
                };
                img.src = LOGO_URL;
            });
        };

        const initializeSectionData = () => {
            secciones.forEach(nombre => {
                const key = "seccionData_" + nombre;
                if (!localStorage.getItem(key)) {
                    const data = { photos: [], comment: "" };
                    localStorage.setItem(key, JSON.stringify(data));
                }
            });
        };

        inicioForm.addEventListener("submit", async e => {
            e.preventDefault();
            const tienda = document.getElementById("tienda").value.trim();
            const persona = document.getElementById("persona").value.trim();
            if (!tienda || !persona) {
                alert("Por favor completa todos los campos.");
                return;
            }
            localStorage.setItem("tienda", tienda);
            localStorage.setItem("persona", persona);
            
            initializeSectionData(); 

            document.getElementById("tienda").value = localStorage.getItem("tienda") || "";
            document.getElementById("persona").value = localStorage.getItem("persona") || "";

            portada.style.display = "none";
            mainApp.style.display = "block";

            botonesSecciones.innerHTML = "";
            secciones.forEach(nombre => {
                const btn = document.createElement("button");
                btn.textContent = nombre;
                btn.className = "seccion-btn";
                btn.type = "button";

                const contenedor = document.createElement("div");
                contenedor.className = "contenido-seccion";

                const inputCamara = document.createElement("input");
                inputCamara.type = "file";
                inputCamara.accept = "image/*";
                inputCamara.capture = "environment";
                inputCamara.style.display = "none";

                const inputGaleria = document.createElement("input");
                inputGaleria.type = "file";
                inputGaleria.accept = "image/*";
                inputGaleria.multiple = true;
                inputGaleria.style.display = "none";

                const titulo = document.createElement("h3");
                titulo.textContent = nombre;
                contenedor.appendChild(titulo);

                const btnCamara = document.createElement("button");
                btnCamara.textContent = "Tomar Foto";
                btnCamara.className = "btn-foto";
                btnCamara.type = "button";
                contenedor.appendChild(btnCamara);

                const btnGaleria = document.createElement("button");
                btnGaleria.textContent = "Seleccionar Fotos";
                btnGaleria.className = "btn-foto";
                btnGaleria.type = "button";
                contenedor.appendChild(btnGaleria);

                const previewDiv = document.createElement("div");
                previewDiv.className = "preview-images";
                contenedor.appendChild(previewDiv);

                const comentario = document.createElement("textarea");
                comentario.placeholder = "Comentario para esta sección (opcional)";
                contenedor.appendChild(comentario);

                const sectionKey = "seccionData_" + nombre;

                const loadSectionData = () => {
                    previewDiv.innerHTML = "";
                    const data = JSON.parse(localStorage.getItem(sectionKey));
                    if (data && data.photos) {
                        data.photos.forEach((src, index) => { 
                            const imgContainer = document.createElement("div");
                            imgContainer.className = "image-container";

                            const img = document.createElement("img");
                            img.src = src;
                            img.alt = `Imagen de ${nombre} ${index + 1}`;
                            imgContainer.appendChild(img);

                            const deleteBtn = document.createElement("button");
                            deleteBtn.textContent = "x";
                            deleteBtn.className = "delete-image-btn";
                            deleteBtn.title = "Eliminar imagen";
                            deleteBtn.addEventListener("click", () => {
                                let currentData = JSON.parse(localStorage.getItem(sectionKey));
                                currentData.photos.splice(index, 1); 
                                localStorage.setItem(sectionKey, JSON.stringify(currentData));
                                loadSectionData(); 
                            });
                            imgContainer.appendChild(deleteBtn);
                            previewDiv.appendChild(imgContainer);
                        });
                    }
                    comentario.value = (data && data.comment) ? data.comment : "";
                };
                loadSectionData(); 

                btn.addEventListener("click", () => {
                    const todas = document.querySelectorAll(".contenido-seccion");
                    todas.forEach(c => {
                        if (c !== contenedor) c.style.display = "none";
                    });
                    if (contenedor.style.display === "block") {
                        contenedor.style.display = "none";
                    } else {
                        contenedor.style.display = "block";
                    }
                    if(contenedor.style.display === "block"){
                        contenedor.scrollIntoView({behavior:"smooth"});
                    }
                });

                btnCamara.addEventListener("click", () => {
                    inputCamara.click();
                });
                btnGaleria.addEventListener("click", () => {
                    inputGaleria.click();
                });

                // --- FUNCION saveImages MODIFICADA PARA REDIMENSIONAR ---
                const saveImages = (files) => {
                    let currentData = JSON.parse(localStorage.getItem(sectionKey));
                    const readerPromises = [];
                    const MAX_WIDTH = 1200; // Ancho máximo para imágenes (en píxeles)
                    const MAX_HEIGHT = 1200; // Alto máximo para imágenes (en píxeles)
                    const JPEG_QUALITY = 0.8; // Calidad de compresión para JPEG (0.0 a 1.0)

                    for (let file of files) {
                        readerPromises.push(new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = e => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;

                                    // Calcula nuevas dimensiones manteniendo la proporción
                                    if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                                        const aspectRatio = width / height;
                                        if (width > MAX_WIDTH) {
                                            width = MAX_WIDTH;
                                            height = width / aspectRatio;
                                        }
                                        if (height > MAX_HEIGHT) {
                                            height = MAX_HEIGHT;
                                            width = height * aspectRatio;
                                        }
                                    }

                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);

                                    // Convierte a JPEG para mejor compresión, si es una imagen con transparencia, puedes mantener PNG
                                    const resizedDataURL = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
                                    currentData.photos.push(resizedDataURL);
                                    resolve();
                                };
                                img.onerror = reject;
                                img.src = e.target.result;
                            };
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        }));
                    }

                    Promise.all(readerPromises).then(() => {
                        localStorage.setItem(sectionKey, JSON.stringify(currentData));
                        loadSectionData();
                    }).catch(error => {
                        console.error("Error durante el procesamiento de imágenes:", error);
                        alert("Hubo un error al procesar una o más imágenes. Podrían ser demasiado grandes o corruptas.");
                    });
                };
                // --- FIN FUNCION saveImages MODIFICADA ---

                inputCamara.addEventListener("change", e => {
                    if (e.target.files.length > 0) {
                        saveImages(e.target.files);
                        inputCamara.value = "";
                    }
                });

                inputGaleria.addEventListener("change", e => {
                    if (e.target.files.length > 0) {
                        saveImages(e.target.files);
                        inputGaleria.value = "";
                    }
                });

                comentario.addEventListener("input", () => {
                    let currentData = JSON.parse(localStorage.getItem(sectionKey));
                    currentData.comment = comentario.value;
                    localStorage.setItem(sectionKey, JSON.stringify(currentData));
                });

                botonesSecciones.appendChild(btn);
                botonesSecciones.appendChild(contenedor);
            });
        });

        // Event listener para el botón "Nuevo Reporte"
        btnNuevoReporte.addEventListener("click", () => {
            if (confirm("¿Estás seguro de que quieres iniciar un nuevo reporte? Todos los datos actuales se borrarán.")) {
                secciones.forEach(nombre => {
                    localStorage.removeItem("seccionData_" + nombre);
                });
                localStorage.removeItem("tienda");
                localStorage.removeItem("persona");

                document.getElementById("tienda").value = "";
                document.getElementById("persona").value = "";

                mainApp.style.display = "none";
                portada.style.display = "block";
                botonesSecciones.innerHTML = ""; 
            }
        });

        // --- Función para añadir encabezado y pie de página ---
        const addHeaderAndFooter = (doc, pageNumber) => {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const textPadding = 5; 
            const headerBottomLineY = 30; 

            let finalLogoHeight = 0; 
            const logoStart_Y = 10; 

            if (logoBase64 && logoOriginalWidth > 0 && logoOriginalHeight > 0) {
                const pdfLogoWidth = 30; 
                const calculatedLogoHeight = (pdfLogoWidth / logoOriginalWidth) * logoOriginalHeight;
                const maxLogoHeight = 15; 
                finalLogoHeight = Math.min(calculatedLogoHeight, maxLogoHeight);

                doc.addImage(logoBase64, 'PNG', margin, logoStart_Y, pdfLogoWidth, finalLogoHeight);
            } else {
                console.warn("No se pudo dibujar el logo en el encabezado porque logoBase64 es nulo o las dimensiones originales no se capturaron. Revisa la consola para más detalles.");
            }

            doc.setFontSize(18); 
            doc.setTextColor("#2c3e50"); 
            
            const titleX = margin + (finalLogoHeight > 0 ? 30 : 0) + textPadding; 
            const titleY = logoStart_Y + (finalLogoHeight / 2) + 3; 

            doc.text("REPORTE DE IMPRESORES DE ETIQUETAS", titleX, titleY);
            
            doc.setDrawColor(150); 
            doc.setLineWidth(0.3); 
            doc.line(margin, headerBottomLineY, pageWidth - margin, headerBottomLineY); 

            doc.setFontSize(10);
            doc.setTextColor(150); 
            doc.text(`Página ${pageNumber}`, pageWidth - margin, pageHeight - 10, { align: "right" });
            doc.setTextColor(0); 
            doc.setDrawColor(0); 
        };

        generarPDFBtn.addEventListener("click", async () => {
            const tienda = localStorage.getItem("tienda") || "Sin Nombre Tienda";
            const persona = localStorage.getItem("persona") || "Sin Nombre Responsable";
            const currentDate = new Date().toLocaleDateString('es-ES', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            let hasContent = false;
            for (const nombre of secciones) {
                const sectionData = JSON.parse(localStorage.getItem("seccionData_" + nombre));
                if (sectionData && (sectionData.photos.length > 0 || sectionData.comment.trim().length > 0)) {
                    hasContent = true;
                    break;
                }
            }

            if (!hasContent) {
                alert("No hay datos (fotos o comentarios) para generar el reporte. Por favor, añada contenido a alguna sección.");
                return;
            }

            loadingOverlay.style.display = 'flex';

            try {
                await loadLogoAsBase64();
            } catch (error) {
                alert("No se pudo cargar el logo para el PDF. Se generará sin él. Por favor, verifica la URL del logo o tu conexión a internet. Si el problema persiste, es probable que la imagen tenga restricciones de seguridad (CORS).");
                logoBase64 = null; 
                logoOriginalWidth = 0; 
                logoOriginalHeight = 0;
            }

            const doc = new jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: "a4",
            });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentStartY = 35; 

            addHeaderAndFooter(doc, 1); 
            
            doc.setFontSize(14); 
            let currentY = contentStartY + 5; 

            doc.text(`Tienda: ${tienda}`, margin, currentY);
            currentY += 10;
            doc.text(`Responsable: ${persona}`, margin, currentY);
            currentY += 10;
            doc.text(`Fecha del Reporte: ${currentDate}`, margin, currentY);
            currentY += 20; 

            let pageCounter = 1; 
            let firstContentSectionDrawn = false; 

            for (const nombre of secciones) {
                const sectionData = JSON.parse(localStorage.getItem("seccionData_" + nombre));

                if (!sectionData || (sectionData.photos.length === 0 && sectionData.comment.trim().length === 0)) {
                    continue; 
                }

                // Si no es la primera sección de contenido, agregar nueva página
                if (firstContentSectionDrawn) {
                    doc.addPage();
                    pageCounter++;
                    addHeaderAndFooter(doc, pageCounter);
                    currentY = contentStartY; 
                } else {
                    firstContentSectionDrawn = true;
                }

                doc.setFontSize(18);
                doc.setTextColor("#2c3e50");
                doc.text(nombre, pageWidth / 2, currentY + 5, { align: "center" }); 
                currentY += 20; 

                // --- Lógica para imágenes en fila y centradas (Máximo 2 por fila, ajustando tamaño) ---
                const imagesPerRow = 2; // Máximo 2 imágenes por fila
                const imgGap = 5;     // Espacio entre imágenes

                let calculatedImgWidth = 0;
                let calculatedImgHeight = 0;
                
                // Si hay fotos, calculamos el tamaño dinámico
                if (sectionData.photos.length > 0) {
                    const minCommentHeight = 30; // Estimado para la caja de comentario si existe
                    const spaceForComment = sectionData.comment.trim().length > 0 ? minCommentHeight + 15 : 0; // 15 de padding
                    
                    // Espacio vertical total disponible en la página para las imágenes
                    // Consideramos el espacio restante hasta el margen inferior
                    const availableSpaceForImages = pageHeight - currentY - margin - spaceForComment - 5; // -5 extra margin

                    const numRows = Math.ceil(sectionData.photos.length / imagesPerRow);
                    const totalVerticalGap = (numRows - 1) * imgGap;

                    // Calcular la altura máxima que puede tener cada imagen
                    calculatedImgHeight = (availableSpaceForImages - totalVerticalGap) / numRows;
                    
                    // Asegurar que la imagen no sea más ancha de lo que cabe en 2 columnas con su espacio
                    const maxPossibleWidthForTwoImages = (pageWidth - (margin * 2) - imgGap) / imagesPerRow;
                    
                    // Elegir el menor entre la altura calculada (para que quepa verticalmente) 
                    // y el ancho máximo para 2 imágenes (para que quepa horizontalmente)
                    calculatedImgWidth = Math.min(calculatedImgHeight, maxPossibleWidthForTwoImages); 
                    calculatedImgHeight = calculatedImgWidth; // Mantenerla cuadrada
                    
                    // Si calculatedImgWidth es muy pequeño, poner un mínimo para que no desaparezca
                    if (calculatedImgWidth < 20) { 
                        console.warn("Imágenes demasiado pequeñas, ajustando a un mínimo de 20x20mm.");
                        calculatedImgWidth = 20;
                        calculatedImgHeight = 20;
                    }
                }

                let imagesInCurrentRow = 0;
                let currentRowStartX = 0; 
                let currentRowMaxHeight = 0; 

                for (let i = 0; i < sectionData.photos.length; i++) {
                    const imgData = sectionData.photos[i];

                    // Si es el inicio de una nueva fila o la imagen actual no cabe en la fila actual
                    if (imagesInCurrentRow === 0 || imagesInCurrentRow >= imagesPerRow) {
                        if (imagesInCurrentRow >= imagesPerRow) { 
                            currentY += currentRowMaxHeight + imgGap; 
                        }
                        
                        imagesInCurrentRow = 0;
                        currentRowMaxHeight = 0;

                        const numImagesForThisRow = Math.min(imagesPerRow, sectionData.photos.length - i);
                        const totalRowWidth = (numImagesForThisRow * calculatedImgWidth) + ((numImagesForThisRow - 1) * imgGap);
                        
                        currentRowStartX = (pageWidth - totalRowWidth) / 2;
                    }

                    const imgX = currentRowStartX + (imagesInCurrentRow * (calculatedImgWidth + imgGap));

                    try {
                        const imgType = imgData.substring("data:image/".length, imgData.indexOf(";base64")).toUpperCase();
                        doc.addImage(imgData, imgType, imgX, currentY, calculatedImgWidth, calculatedImgHeight); 
                    } catch (error) {
                        console.warn(`No se pudo añadir una imagen en sección "${nombre}":`, error);
                    }

                    imagesInCurrentRow++;
                    currentRowMaxHeight = Math.max(currentRowMaxHeight, calculatedImgHeight);
                }
                
                if (sectionData.photos.length > 0) {
                   currentY += currentRowMaxHeight + 15; 
                }

                // --- Comentario en Recuadro ---
                if (sectionData.comment && sectionData.comment.trim().length > 0) {
                    doc.setFontSize(12);
                    const commentText = "Comentario: " + sectionData.comment;
                    const commentBoxWidth = pageWidth - margin * 2; 
                    const padding = 5; 

                    const splitComment = doc.splitTextToSize(commentText, commentBoxWidth - padding * 2);
                    const textHeight = splitComment.length * 7; 

                    const commentBoxHeight = textHeight + padding * 2; 

                    // Esta comprobación es más bien una salvaguarda, ya que el espacio de las fotos
                    // ya considera el espacio para el comentario. Pero es bueno mantenerla.
                    if (currentY + commentBoxHeight + 5 > pageHeight - margin) {
                        // En este escenario, si solo el comentario no cabe, lo movemos a una nueva página.
                        doc.addPage();
                        pageCounter++;
                        addHeaderAndFooter(doc, pageCounter);
                        currentY = contentStartY; 
                    }

                    doc.rect(margin, currentY, commentBoxWidth, commentBoxHeight, 'S'); 
                    doc.text(splitComment, margin + padding, currentY + padding + 5, { align: "left" });
                    currentY += commentBoxHeight + 15; 
                }
            }

            doc.save(`Reporte_${tienda.replace(/\s/g, "_")}_${new Date().toISOString().slice(0,10)}.pdf`);

            loadingOverlay.style.display = 'none';
        });
    </script>

</body>
</html>